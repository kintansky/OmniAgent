{% extends 'base.html' %}

{% load static %}
{% block header_extends %}
    <link rel="stylesheet" href="{% static 'devices.css' %}">
{% endblock %}

{% block navbar_resource_active %}active{% endblock %}

{% block content %}
    <div class="container-fluid">
        <br>
        <ol class="breadcrumb">
            <li><a href="{% url 'dashboard' %}">Home</a></li>
            <li><a href="">Resource</a></li>
            <li><a href="{% url 'ip_record' %}">IP Records</a></li>
            <li class="active">Allocate IP</li>
        </ol>
        <h2 class="sub-header">业务地址分配</h2>
        {% if user.is_authenticated %}
            {# user already login #}
            <div class="row">
                <div class="panel panel-default">
                    <div class="panel-heading">详细信息</div>
                    <div class="panel-body">
                        <form id="ip-detail-form" action="" method="POST">
                            <!-- 隐藏内容，调试可关闭style="display: none;" -->
                            <div class="form-group" style="display: none;">
                                <input name="target-list" id='target-list' class="form-control" readonly="readonly">
                                <label for="{{ new_ip_allocation_form.include_private_ip.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.include_private_ip.label }}</label>
                                {{ new_ip_allocation_form.include_private_ip }}
                                <!-- <p class="text-danger error-data">{{ field.errors.as_text }}</p> -->
                                <label for="{{ new_ip_allocation_form.icp_id.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.icp_id.label }}</label>
                                {{ new_ip_allocation_form.icp_id }}
                            </div>
                            <div class="row">
                                <div class="col-sm-12">
                                    <h4><span class="label label-warning">1 客户信息</span></h4>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.order_num.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.order_num.label }}</label>
                                        {{ new_ip_allocation_form.order_num }}
                                        <p class="text-danger error-data" id="id_error_order_num">{{ new_ip_allocation_form.order_num.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.client_name.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.client_name.label }}</label>
                                        {{ new_ip_allocation_form.client_name }}
                                        <p class="text-danger error-data" id="id_error_client_name">{{ new_ip_allocation_form.client_name.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.service_id.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.service_id.label }}</label>
                                        {{ new_ip_allocation_form.service_id }}
                                        <p class="text-danger error-data" id="id_error_service_id">{{ new_ip_allocation_form.service_id.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.group_id.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.group_id.label }}</label>
                                        {{ new_ip_allocation_form.group_id }}
                                        <p class="text-danger error-data" id="id_error_group_id">{{ new_ip_allocation_form.group_id.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.product_id.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.product_id.label }}</label>
                                        {{ new_ip_allocation_form.product_id }}
                                        <p class="text-danger error-data" id="id_error_product_id">{{ new_ip_allocation_form.product_id.errors.as_text }}</p>
                                    </div>
                                </div>

                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-12">
                                    <h4><span class="label label-success">2 网络信息</span></h4>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.olt.id_for_label }}" class="col-sm-2 control-label" data-toggle="popover" data-trigger="hover" title="填写帮助" data-content="如果无法匹配到OLT，请手工填入">{{ new_ip_allocation_form.olt.label }}?</label>
                                        {{ new_ip_allocation_form.olt }}
                                        <div id="olt-list" class="olt-list">
                                        </div>
                                        <p class="text-danger error-data" id="id_error_olt">{{ new_ip_allocation_form.olt.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.bng.id_for_label }}" class="col-sm-2 control-label" data-toggle="popover" data-trigger="hover" title="填写帮助" data-content="正常情况下应会自动生成两台BNG1/BNG2这样的格式，如果未正常生成，请手工补全">{{ new_ip_allocation_form.bng.label }}?</label>
                                        {{ new_ip_allocation_form.bng }}
                                        <p class="text-danger error-data" id="id_error_bng">{{ new_ip_allocation_form.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.logic_port.id_for_label }}" class="col-sm-2 control-label" data-toggle="popover" data-trigger="hover" data-html="true" title="填写帮助" data-content="子接口规范应为 端口:外层vlan.内层vlan<br>如无内外层vlan请使用**:0.0的格式">{{ new_ip_allocation_form.logic_port.label }}?</label>
                                        {{ new_ip_allocation_form.logic_port }}
                                        <p class="text-danger error-data" id="id_error_logic_port">{{ new_ip_allocation_form.logic_port.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.description.id_for_label }}" class="col-sm-2 control-label" data-toggle="popover" data-trigger="hover" title="填写帮助" data-content="描述内容应未 abcdefg(**M)或abcdefg(**G),包含带宽字段">{{ new_ip_allocation_form.description.label }}?</label>
                                        {{ new_ip_allocation_form.description }}
                                        <p class="text-danger error-data" id="id_error_description">{{ new_ip_allocation_form.description.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.network_type.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.network_type.label }}</label>
                                        {{ new_ip_allocation_form.network_type }}
                                        <p class="text-danger error-data" id="id_error_network_type">{{ new_ip_allocation_form.network_type.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.access_type.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.access_type.label }}</label>
                                        {{ new_ip_allocation_form.access_type }}
                                        <p class="text-danger error-data" id="id_error_access_type">{{ new_ip_allocation_form.access_type.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-12">
                                    <a href="" data-toggle="modal" data-target=".bs-example-modal" class="modal_form_trigger" id="add_ip">
                                        <h4><span class="label label-primary">3 点击添加地址</span></h4>
                                    </a>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>类型</th>
                                                <th>第一个IP</th>
                                                <th>最后一个IP</th>
                                                <th>网关</th>
                                                <th>状态</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="conf-ip-table">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-12">
                                    <h4><span class="label label-danger">4 私网附加信息(分配私网IP时必须填写)</span></h4>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.community.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.community.label }}</label>
                                        {{ new_ip_allocation_form.community }}
                                        <p class="text-danger error-data" id="id_error_community">{{  new_ip_allocation_form.community.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.rt.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.rt.label }}</label>
                                        {{ new_ip_allocation_form.rt }}
                                        <p class="text-danger error-data" id="id_error_rt">{{ new_ip_allocation_form.rt.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.rd.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.rd.label }}</label>
                                        {{ new_ip_allocation_form.rd }}
                                        <p class="text-danger error-data" id="id_error_rd">{{ new_ip_allocation_form.rd.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-12">
                                    <a href="" data-toggle="modal" data-target="#icp-modal" class="modal_form_trigger" id="add_icp">
                                        <h4><span class="label label-default">5 点击添加ICP信息</span></h4>
                                    </a>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-12">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>营业执照</th>
                                                <th>客户地址</th>
                                                <th>保障等级</th>
                                                <th>联系人</th>
                                                <th>派单人</th>
                                            </tr>
                                        </thead>
                                        <tbody id="conf-icp-table">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-12">
                                    <h4><span class="label label-default">6 其他信息</span></h4>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.comment.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.comment.label }}</label>
                                        {{ new_ip_allocation_form.comment }}
                                        <!-- <p class="text-danger error-data">{{ field.errors.as_text }}</p> -->
                                    </div>
                                </div>
                            </div>
                        </form>
                        <button type="submit" id="confirm-allocate-btn" class="btn btn-success pull-right">确认分配</button>
                    </div>
                </div>
            </div>

        {% else %}
            {# user no login #}
            <div class="row">
                <div class="alert alert-danger" role="alert">
                    <span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span>
                    Before allocating resource, please <a href="{% url 'login' %}?from={{ request.get_full_path }}"><strong>LOGIN</strong></a> first!
                </div>
            </div>
        {% endif %}

        <div class="modal fade bs-example-modal" id="ready_ip_modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">添加目标地址</h4>
                    </div>
                    <div class="modal-body">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                目标清单
                                <button id="confirm-ready" type="submit" class="btn btn-success btn-xs pull-right">确认清单</button>
                            </div>
                            <div class="panel-body">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>类型</th>
                                            <th>第一个IP</th>
                                            <th>最后一个IP</th>
                                            <th>网关</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="target-ip-table">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <p><strong>可通过以下两种方式添加,添加完成后点击右上角 确认清单</strong></p>
                        <div class="panel panel-default">
                            <div class="panel-heading">从已配置的地址段上选择（仅公网IP且为非共享网关地址段）</div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="dropdown">
                                            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                              可选IP清单，点选添加
                                              <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1" id="can_allocated_ip">
                                            </ul>
                                        </div>
                                    </div>
                                    <!-- <div class="col-md-6">
                                        <div class="checkbox">
                                            <label>
                                              <input type="checkbox">全选
                                            </label>
                                        </div>
                                    </div> -->
                                </div>
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">自由分配（公网或私网）</div>
                            <div class="panel-body">
                                <form id="generate-ip-form2" action="" method="POST" class="form-inline">
                                    <div class="form-group">
                                        <label for="{{ ip_target_form.ip_func.id_for_label }}">{{ ip_target_form.ip_func.label }}</label>
                                        {{ ip_target_form.ip_func }}
                                        <label for="{{ ip_target_form.state.id_for_label }}">{{ ip_target_form.state.label }}</label>
                                        {{ ip_target_form.state }}
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-12">
                                            <h5><span class="label label-default" data-toggle="popover" data-trigger="hover" data-html="true" title="帮助" data-content="1、分配整个IP段，“往后”选框请填任意一个小于0的值<br>2、分配单个IP，“往后”选框请填0或不填<br>3、分配连续多个IP，“往后”选框请填写起始IP开始连续分配的个数">请填写以下连续地址或地址段信息(点击查看填写帮助)</span></h5>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label for="{{ ip_target_form.first_ip.id_for_label }}">{{ ip_target_form.first_ip.label }}</label>
                                                {{ ip_target_form.first_ip }}
                                                <label for="{{ ip_target_form.ip_num.id_for_label }}">+{{ ip_target_form.ip_num.label }}</label>
                                                {{ ip_target_form.ip_num }}
                                                <strong>个</strong>
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="form-group">
                                                <label for="{{ ip_target_form.gateway.id_for_label }}">{{ ip_target_form.gateway.label }}</label>
                                                {{ ip_target_form.gateway }}
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <br>
                                <button type="submit" class="btn btn-success btn-sm generate-ip">添加IP</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
        <!-- icp-modal -->
        <div class="modal fade" id="icp-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">添加ICP信息</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="input-group">
                                    <textarea id="icp_text" name="icp_text" class="form-control" rows="4"></textarea>
                                    <span class="input-group-addon">
                                        <button id="id_parse_icp" class="btn btn-default" type="button">解析</button>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-sm-12">
                                <!-- 解析ICP后补全的内容 -->
                                <form id="icp_info_form" class="form">
                                    {% for field in new_icp_info_form %}
                                        <div class="form-group">
                                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                            {{ field }}
                                            <p id="error_{{ field.id_for_label }}" class="text-danger icp-error-data">{{ field.errors.as_text }}</p>
                                        </div>
                                    {% endfor %}
                                    <button type="reset" class="btn btn-danger btn-sm">重置</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="confirm_icp_info" type="submit" class="btn btn-primary">确认新增</button>
                    </div>
                </div>
            </div>
        </div>


    </div>
    
{% endblock %}

{% block tail_script %}
<script>
    $(document).ready(function(){
        // 添加IP
        $("#add_ip").click(function(){
            // 清理旧数据
            $("#target-ip-table").html(""); 
            document.getElementById("generate-ip-form2").reset();
            $.ajax({
                url: "{% url 'ajax_get_olt_can_allocated_ip' %}",
                type: 'GET',
                data: $('#id_olt').serialize(),
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        // console.log(data);
                        // $("#id_bng").val(data['bng_list']); // 更新清单
                        var olts = data['ip_list'].split(",");
                        $("#can_allocated_ip").html("");
                        for(var i=0;i<olts.length;i++){
                            $("#can_allocated_ip").append('<li class="ip-item"><a>'+olts[i]+'</a></li>');
                        }
                    }else{
                        console.log(data);
                        alert('error');
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });
        // 从已配置的地址段上分配->添加至临时清单
        $(document).on("click", ".ip-item", function(){
            var ready_ip_item = $(this).text();
            var tmpData = ready_ip_item.split(" 网关");
            var last_ip = tmpData[0].split("/")[0];
            $("#target-ip-table").append("<tr><td class=\"ready_ip_func\">公网</td><td class=\"ready_first_ip\">"+tmpData[0]+"</td><td class=\"ready_last_ip\">"+last_ip+"</td><td class=\"ready_gw\">"+tmpData[1]+"</td><td class=\"ready_state\">已启用</td><td><button id=\""+tmpData[0]+"p0"+"\" type=\"button\" class=\"btn btn-danger btn-xs remove-ready-ip-btn\">取消</button></td><td class=\"from\" style=\"display: none;\">在用地址段</td></tr>");
            $(this).remove();   // 删除清单的可选项
        });
        // 临时清单的取消按钮
        $(document).on("click", ".remove-ready-ip-btn", function(){   // 动态绑定需要使用.on
            var remove_target = $(this).parent().parent();  // 需要删除的对象为btn的祖父
            if($(this).parent().siblings(".from").text() == "在用地址段"){  // 从在用地址段中分的归还回去在用地址段的选框
                var first_ip = $(this).parent().siblings(".ready_first_ip").text();
                var gw = $(this).parent().siblings(".ready_gw").text();
                $("#can_allocated_ip").append('<li class="ip-item"><a>'+first_ip+' 网关'+gw+'</a></li>');
            }
            // 其他情况直接删除即可
            remove_target.remove();
        });
        // 从新地址段分配->添加至临时清单
        $(".generate-ip").click(function(){
            $.ajax({
                url: "{% url 'generate_ip2' %}",
                type: 'POST',
                data:  $('#generate-ip-form2').serialize() + "&csrfmiddlewaretoken=" + "{{ csrf_token }}",
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        // console.log(data);
                        $("#target-ip-table").append("<tr><td class=\"ready_ip_func\">"+data['ip_func']+"</td><td class=\"ready_first_ip\">"+data['first_ip']+"</td><td class=\"ready_last_ip\">"+data['last_ip']+"</td><td class=\"ready_gw\">"+data['gw']+"</td><td class=\"ready_state\">"+data['state']+"</td><td><button id=\""+data['target']+"\" type=\"button\" class=\"btn btn-danger btn-xs remove-ready-ip-btn\">取消</button></td><td class=\"from\" style=\"display: none;\">新地址段</td></tr>");
                        // $('#id_include_private_ip').val(data['include_private_ip']);
                    }else{
                        console.log(data);
                        alert(data['error_info']);
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            }); 
        });
        // 临时清单->确认至正式清单
        $("#confirm-ready").click(function(){
            var target_list_append = {};
            $("#target-ip-table").children("tr").each(function(){
                target_list_append[$(this).find(".remove-ready-ip-btn").attr("id")] = [$(this).children(".ready_ip_func").text(), $(this).children(".ready_state").text(), $(this).children(".ready_gw").text()];
            });
            $.ajax({
                url: "{% url 'confirm_ready_ip' %}",
                type: 'POST',
                data:  $('#target-list').serialize() + "&target_list_append=" + JSON.stringify(target_list_append) + "&csrfmiddlewaretoken=" + "{{ csrf_token }}",
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        // console.log(data);
                        $('#target-list').val(data['target_list']);
                        $("#ready_ip_modal").modal("hide");
                        var table_data = JSON.parse(data['table_data']);
                        console.log(table_data);
                        $("#conf-ip-table").html("");   // 清空旧数据
                        for (var key in table_data){
                            var item = table_data[key];
                            $("#conf-ip-table").append("<tr><td>"+item[0]+"</td><td>"+item[1]+"</td><td>"+item[2]+"</td><td>"+item[3]+"</td><td>"+item[4]+"</td><td><button id=\""+key+"\" type=\"button\" class=\"btn btn-danger btn-xs remove-conf-ip-btn\">取消</button></td></tr>");
                        }
                        $('#id_include_private_ip').val(data['include_private_ip']);
                    }else{
                        console.log(data);
                        alert(data['error_info']);
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });
        // 确认清单的取消按钮
        $(document).on("click", ".remove-conf-ip-btn", function(){   // 动态绑定需要使用.on
            var remove_target = $(this).parent().parent();  // 需要删除的对象为btn的祖父
            $.ajax({
                url: "{% url 'remove_conf_ip' %}",
                type: 'POST',
                data: $('#target-list').serialize() + "&remove-target=" + $(this).attr('id')+ "&csrfmiddlewaretoken=" + "{{ csrf_token }}",
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        // console.log(data);
                        remove_target.remove();
                        $("#target-list").val(data['target_list']); // 更新清单
                        $("#id_include_private_ip").val(data['include_private_ip']);
                    }else{
                        console.log(data);
                        alert('error');
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });

        // 确认分配
        $("#confirm-allocate-btn").click(function(){
            $('#loading').modal('show');
            $.ajax({
                url: "{% url 'confirm_allocate' %}",
                type: 'POST',
                data: $('#ip-detail-form').serialize() + "&csrfmiddlewaretoken=" + "{{ csrf_token }}",
                cache: false,
                success: function(data){
                    $('#loading').modal('hide');
                    if(data['status'] == 'success'){
                        // console.log(data);
                        $("p.error-data").text(""); // 清空错误信息
                        document.getElementById('ip-detail-form').reset();  // 清空form
                        $("#conf-ip-table").html(""); // 清空目标ip table
                        $("#conf-icp-table").html(""); // 清空icp table
                        alert("分配成功");
                    }else{
                        // console.log(data);
                        $("p.error-data").text("");
                        if ('error_info' in data){
                            alert("分配失败，请查看对应字段的错误信息");
                            var error_data = JSON.parse(data['error_info']);
                            for (var key in error_data){
                                var item = error_data[key];
                                // console.log(item[0]['message']);
                                // 按照对应id补全错误信息
                                $("#id_error_"+key).text(item[0]['message']);
                            }
                        }
                        if("other_error" in data){
                            alert(data["other_error"]);
                        }
                    }
                },
                error: function(xhr){
                    $('#loading').modal('hide');
                    console.log(xhr);
                    alert("分配失败");
                }
            });
        });
        // // 清理所有目标地址
        // $("#clear-all-target-btn").click(function(){
        //     $("#target-id-table").html("");
        //     $("#target-list").val("{}");
        // });
        // 模糊匹配OLT清单
        $("#id_olt").keyup(function(){
            if($(this).val() == ""){
                $("#olt-list").css("display", "none");
                return;
            }
            $.ajax({
                url: "{% url 'get_olt_bng' 'olt' %}",
                type: 'GET',
                data: $(this).serialize(),
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        // console.log(data);
                        var olts = data['olt_list'].split(",");
                        var t = "<ul class=\"list-group\">";
                        for(var i=0;i<olts.length;i++){
                            // console.log(olts[i]);
                            t += "<li class=\"list-group-item olt-item\">"+olts[i]+"</li>";
                        }
                        t += "</ul>";
                        $("#olt-list").html(t);
                        $("#id_access_type").val(data['access_type']);
                        $("#olt-list").css("display", "block");
                    }else{
                        // alert('error');
                        if("olt_count" in data){
                            $("#olt-list").css("display", "none");
                        }else{
                            var t = "<ul class=\"list-group\"><li class=\"list-group-item olt-item\">"+data["olt_list"]+"</li>";
                            $("#olt-list").html(t);
                            $("#olt-list").css("display", "block");
                        }
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });
        // 选择olt
        $(document).on("click", ".olt-item", function(){
            var auto_item = $(this).text();
            $("#olt-list").css("display", "none");
            if (auto_item != '无候选结果'){
                $("#id_olt").val(auto_item);
            }
        });
        // // 设置失去焦点时隐藏，避免遮挡
        // $("#id_olt").blur(function(){
        //     $("#olt-list").css("display", "none");
        // });
        // BNG 回填
        $("#id_bng").click(function(){
            $.ajax({
                url: "{% url 'get_olt_bng' 'bng' %}",
                type: 'GET',
                data: $('#id_olt').serialize(),
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        // console.log(data);
                        $("#id_bng").val(data['bng_list']); // 更新清单
                    }else{
                        console.log(data);
                        alert('error');
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });
        // 点开modal的时候，清理icp表单
        $("#add_icp").click(function(){
            $("#icp_text").val("");
        });
        // 解析icp信息
        $("#id_parse_icp").click(function(){
            $.ajax({
                url: "{% url 'parse_icp' %}",
                type: 'GET',
                data: $("#icp_text").serialize(),
                cache: false,
                success: function(data){
                    var parsed_icp_result = JSON.parse(data['parsed_icp_result']);
                    for(var key in parsed_icp_result){
                        $('#'+key).val(parsed_icp_result[key]);
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });
        // 确认ICP信息
        $('#confirm_icp_info').click(function(){
            $('#loading').modal('show');
            $.ajax({
                url: "{% url 'confirm_icp' %}",
                type: 'POST',
                data: $("#icp_info_form").serialize() + "&csrfmiddlewaretoken=" + "{{ csrf_token }}",
                cache: false,
                success: function(data){
                    $('#loading').modal('hide');
                    if(data['status'] == 'success'){
                        $("p.icp-error-data").text(""); // 清空错误信息
                        document.getElementById('icp_info_form').reset();  // 清空form
                        $('#id_icp_id').val(data['id']); // 将icp——id回填给分配form
                        $('#conf-icp-table').html('<tr><td>'+data['identify_id']+'</td><td>'+data['client_address']+'</td><td>'+data['guard_level']+'</td></td><td>'+data['client_tech']+data['client_tech_contact']+'</td><td>'+data['distributor']+data['distributor_contact']+'</td></tr>');
                        alert("ICP备案信息创建成功");
                        $("#icp-modal").modal("hide");
                    }else{
                        // console.log(data);
                        $("p.icp-error-data").text("");
                        if ('error_info' in data){
                            alert("创建失败，请查看对应字段的错误信息");
                            var error_data = JSON.parse(data['error_info']);
                            for (var key in error_data){
                                var item = error_data[key];
                                // console.log(item[0]['message']);
                                // 按照对应id补全错误信息
                                $("#error_id_"+key).text(item[0]['message']);
                            }
                        }
                    }
                },
                error: function(xhr){
                    $('#loading').modal('hide');
                    console.log(xhr);
                }
            });
        });
    });
</script>
{% endblock %}