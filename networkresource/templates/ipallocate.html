{% extends 'base.html' %}

{% load static %}
{% block header_extends %}
    <link rel="stylesheet" href="{% static 'devices.css' %}">
{% endblock %}

{% block navbar_resource_active %}active{% endblock %}

{% block content %}
    <div class="container-fluid">
        <br>
        <ol class="breadcrumb">
            <li><a href="{% url 'dashboard' %}">Home</a></li>
            <li><a href="">Resource</a></li>
            <li><a href="{% url 'ip_record' %}">IP Records</a></li>
            <li class="active">Allocate IP</li>
        </ol>
        <h2 class="sub-header">业务地址分配</h2>
        {% if user.is_authenticated %}
            {# user already login #}
            <div class="row">
                <div class="col-md-4">
                    <div class="panel panel-info">
                        <div class="panel-heading">目标IP</div>
                        <div class="panel-body">
                            <form id="generate-ip-form" action="" method="POST" class="form-inline">
                                <div class="form-group">
                                    <label for="{{ ip_target_form.ip_func.id_for_label }}">{{ ip_target_form.ip_func.label }}</label>
                                    {{ ip_target_form.ip_func }}
                                    <label for="{{ ip_target_form.state.id_for_label }}">{{ ip_target_form.state.label }}</label>
                                    {{ ip_target_form.state }}
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <span class="label label-danger">请填写以下连续地址或地址段信息</span>
                                    </div>
                                </div>
                                <br>
                                <div class="form-group">
                                    <label for="{{ ip_target_form.first_ip.id_for_label }}">{{ ip_target_form.first_ip.label }}</label>
                                    {{ ip_target_form.first_ip }}
                                    <label for="{{ ip_target_form.ip_num.id_for_label }}">+{{ ip_target_form.ip_num.label }}</label>
                                    {{ ip_target_form.ip_num }}
                                    <strong>个</strong>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <span class="label label-danger">或</span>
                                    </div>
                                </div>
                                <br>
                                <div class="form-group">
                                    <label for="{{ ip_target_form.ip_segment.id_for_label }}">{{ ip_target_form.ip_segment.label }}</label>
                                    {{ ip_target_form.ip_segment }}
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <span class="label label-info">网关信息</span>
                                    </div>
                                </div>
                                <br>
                                <div class="form-group">
                                    <label for="{{ ip_target_form.gateway.id_for_label }}">{{ ip_target_form.gateway.label }}</label>
                                    {{ ip_target_form.gateway }}
                                </div>
                            </form>
                            <button type="submit" class="btn btn-success generate-ip pull-right">添加地址</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="panel panel-info">
                        <div class="panel-heading">
                            目标IP清单
                            <button id="clear-all-target-btn" type="submit" class="btn btn-danger btn-xs pull-right">点击重置</button>
                        </div>
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>类型</th>
                                    <th>第一个IP</th>
                                    <th>最后一个IP</th>
                                    <th>网关</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="target-id-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <hr>
            <div class="row">
                <div class="panel panel-default">
                    <div class="panel-heading">详细信息</div>
                    <div class="panel-body">
                        <form id="ip-detail-form" action="" method="POST">
                            <!-- 隐藏内容，调试可关闭style -->
                            <div class="form-group" style="display: none;">
                                <input name="target-list" id='target-list' class="form-control" readonly="readonly">
                                <label for="{{ new_ip_allocation_form.include_private_ip.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.include_private_ip.label }}</label>
                                {{ new_ip_allocation_form.include_private_ip }}
                                <!-- <p class="text-danger error-data">{{ field.errors.as_text }}</p> -->
                            </div>
                            <div class="row">
                                <div class="col-sm-12">
                                    <span class="label label-warning">客户信息</span>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.order_num.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.order_num.label }}</label>
                                        {{ new_ip_allocation_form.order_num }}
                                        <p class="text-danger error-data" id="id_error_order_num">{{ new_ip_allocation_form.order_num.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.client_name.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.client_name.label }}</label>
                                        {{ new_ip_allocation_form.client_name }}
                                        <p class="text-danger error-data" id="id_error_client_name">{{ new_ip_allocation_form.client_name.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.service_id.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.service_id.label }}</label>
                                        {{ new_ip_allocation_form.service_id }}
                                        <p class="text-danger error-data" id="id_error_service_id">{{ new_ip_allocation_form.service_id.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.group_id.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.group_id.label }}</label>
                                        {{ new_ip_allocation_form.group_id }}
                                        <p class="text-danger error-data" id="id_error_group_id">{{ new_ip_allocation_form.group_id.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.product_id.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.product_id.label }}</label>
                                        {{ new_ip_allocation_form.product_id }}
                                        <p class="text-danger error-data" id="id_error_product_id">{{ new_ip_allocation_form.product_id.errors.as_text }}</p>
                                    </div>
                                </div>

                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-12">
                                    <span class="label label-success">网络信息</span>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.olt.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.olt.label }}</label>
                                        {{ new_ip_allocation_form.olt }}
                                        <div id="olt-list" class="olt-list">
                                        </div>
                                        <p class="text-danger error-data" id="id_error_olt">{{ new_ip_allocation_form.olt.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.bng.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.bng.label }}</label>
                                        {{ new_ip_allocation_form.bng }}
                                        <p class="text-danger error-data" id="id_error_bng">{{ new_ip_allocation_form.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.logic_port.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.logic_port.label }}</label>
                                        {{ new_ip_allocation_form.logic_port }}
                                        <p class="text-danger error-data" id="id_error_logic_port">{{ new_ip_allocation_form.logic_port.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.description.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.description.label }}</label>
                                        {{ new_ip_allocation_form.description }}
                                        <p class="text-danger error-data" id="id_error_description">{{ new_ip_allocation_form.description.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.network_type.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.network_type.label }}</label>
                                        {{ new_ip_allocation_form.network_type }}
                                        <p class="text-danger error-data" id="id_error_network_type">{{ new_ip_allocation_form.network_type.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.access_type.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.access_type.label }}</label>
                                        {{ new_ip_allocation_form.access_type }}
                                        <p class="text-danger error-data" id="id_error_access_type">{{ new_ip_allocation_form.access_type.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-12">
                                    <span class="label label-danger">私网附加信息(分配私网IP时必须填写)</span>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.community.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.community.label }}</label>
                                        {{ new_ip_allocation_form.community }}
                                        <p class="text-danger error-data" id="id_error_community">{{  new_ip_allocation_form.community.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.rt.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.rt.label }}</label>
                                        {{ new_ip_allocation_form.rt }}
                                        <p class="text-danger error-data" id="id_error_rt">{{ new_ip_allocation_form.rt.errors.as_text }}</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.rd.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.rd.label }}</label>
                                        {{ new_ip_allocation_form.rd }}
                                        <p class="text-danger error-data" id="id_error_rd">{{ new_ip_allocation_form.rd.errors.as_text }}</p>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-12">
                                    <span class="label label-info">其他信息</span>
                                </div>
                            </div>
                            <br>
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="form-group">
                                        <label for="{{ new_ip_allocation_form.comment.id_for_label }}" class="col-sm-2 control-label">{{ new_ip_allocation_form.comment.label }}</label>
                                        {{ new_ip_allocation_form.comment }}
                                        <!-- <p class="text-danger error-data">{{ field.errors.as_text }}</p> -->
                                    </div>
                                </div>
                            </div>
                        </form>
                        <button type="submit" id="confirm-allocate-btn" class="btn btn-success pull-right">确认分配</button>
                    </div>
                </div>
            </div>

        {% else %}
            {# user no login #}
            <div class="row">
                <div class="alert alert-danger" role="alert">
                    <span class="glyphicon glyphicon-remove-sign" aria-hidden="true"></span>
                    Before allocating resource, please <a href="{% url 'login' %}?from={{ request.get_full_path }}"><strong>LOGIN</strong></a> first!
                </div>
            </div>
        {% endif %}

    </div>
{% endblock %}

{% block tail_script %}
<script>
    $(document).ready(function(){
        // 生成IP
        $(".generate-ip").click(function(){
            $.ajax({
                url: "{% url 'generate_ip' %}",
                type: 'POST',
                data:  $('#target-list').serialize() + "&" + $('#generate-ip-form').serialize() + "&csrfmiddlewaretoken=" + "{{ csrf_token }}",
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        // console.log(data);
                        $('#target-id-table').prepend("<tr><td>"+data['ip_func']+"</td><td>"+data['first_ip']+"</td><td>"+data['last_ip']+"</td><td>"+data['gw']+"</td><td>"+data['state']+"</td><td><button id=\""+data['target']+"\" type=\"button\" class=\"btn btn-danger btn-xs remove-ip-btn\">取消</button></td></tr>");
                        $('#target-list').val(data['target_list']);
                        $('#id_include_private_ip').val(data['include_private_ip']);
                        document.getElementById('generate-ip-form').reset();
                    }else{
                        console.log(data);
                        alert(data['error_info']);
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });
        // 删除目标IP
        $(document).on("click", ".remove-ip-btn", function(){   // 动态绑定需要使用.on
            var remove_target = $(this).parent().parent();  // 需要删除的对象为btn的祖父
            $.ajax({
                url: "{% url 'remove_ip' %}",
                type: 'POST',
                data: $('#target-list').serialize() + "&remove-target=" + $(this).attr('id')+ "&csrfmiddlewaretoken=" + "{{ csrf_token }}",
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        // console.log(data);
                        remove_target.remove();
                        $("#target-list").val(data['target_list']); // 更新清单
                        $("#id_include_private_ip").val(data['include_private_ip']);
                    }else{
                        console.log(data);
                        alert('error');
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });
        // 确认分配
        $("#confirm-allocate-btn").click(function(){
            $.ajax({
                url: "{% url 'confirm_allocate' %}",
                type: 'POST',
                data: $('#ip-detail-form').serialize() + "&csrfmiddlewaretoken=" + "{{ csrf_token }}",
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        // console.log(data);
                        $("p.error-data").text(""); // 清空错误信息
                        document.getElementById('ip-detail-form').reset();  // 清空form
                        $("#target-id-table").html(""); // 清空目标table
                        alert("分配成功");
                    }else{
                        // console.log(data);
                        $("p.error-data").text("");
                        if("error_order_num" in data){
                            $("#id_error_order_num").text(data["error_order_num"]);
                        }
                        if("error_client_name" in data){
                            $("#id_error_client_name").text(data["error_client_name"]);
                        }
                        if("error_olt" in data){
                            $("#id_error_olt").text(data["error_olt"]);
                        }
                        if("error_bng" in data){
                            $("#id_error_bng").text(data["error_bng"]);
                        }
                        if("error_logic_port" in data){
                            $("#id_error_logic_port").text(data["error_logic_port"]);
                        }
                        if("error_description" in data){
                            $("#id_error_description").text(data["error_description"]);
                        }
                        if("error_service_id" in data){
                            $("#id_error_service_id").text(data["error_service_id"]);
                        }
                        if("error_group_id" in data){
                            $("#id_error_group_id").text(data["error_group_id"]);
                        }
                        if("error_product_id" in data){
                            $("#id_error_product_id").text(data["error_product_id"]);
                        }
                        if("error_community" in data){
                            $("#id_error_community").text(data["error_community"]);
                        }
                        if("error_rt" in data){
                            $("#id_error_rt").text(data["error_rt"]);
                        }
                        if("error_rd" in data){
                            $("#id_error_rd").text(data["error_rd"]);
                        }
                        if("other_error" in data){
                            alert(data["other_error"]);
                        }
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });
        // 清理所有目标地址
        $("#clear-all-target-btn").click(function(){
            $("#target-id-table").html("");
            $("#target-list").val("{}");
        });
        // 模糊匹配OLT清单
        $("#id_olt").keyup(function(){
            if($(this).val() == ""){
                $("#olt-list").css("display", "none");
                return;
            }
            $.ajax({
                url: "{% url 'get_olt_bng' 'olt' %}",
                type: 'GET',
                data: $(this).serialize(),
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        console.log(data);
                        var olts = data['olt_list'].split(",");
                        var t = "<ul class=\"list-group\">";
                        for(var i=0;i<olts.length;i++){
                            // console.log(olts[i]);
                            t += "<li class=\"list-group-item olt-item\" οnclick='setSearch_onclick(this)'>"+olts[i]+"</li>"
                        }
                        t += "</ul>"
                        $("#olt-list").html(t);
                        $("#olt-list").css("display", "block");
                    }else{
                        alert('error');
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });
        // 选择olt
        $(document).on("click", ".olt-item", function(){
            var auto_item = $(this).text();
            $("#id_olt").val(auto_item);
            $("#olt-list").css("display", "none");
            $("#id_access_type").val(data['access_type']);
        });
        // 设置失去焦点时隐藏，避免遮挡
        $("#id_olt").blur(function(){
            $("#olt-list").css("display", "none");
        });
        // BNG 回填
        $("#id_bng").click(function(){
            $.ajax({
                url: "{% url 'get_olt_bng' 'bng' %}",
                type: 'GET',
                data: $('#id_olt').serialize(),
                cache: false,
                success: function(data){
                    if(data['status'] == 'success'){
                        // console.log(data);
                        $("#id_bng").val(data['bng_list']); // 更新清单
                    }else{
                        console.log(data);
                        alert('error');
                    }
                },
                error: function(xhr){
                    console.log(xhr);
                }
            });
        });
    });
</script>
{% endblock %}