{% extends 'base.html' %}
{% block title %} Dashboard {% endblock %}
{% block navbar_dashboard_active %}active{% endblock %}

{% load static %}
{% block header_extends %}
    <link rel="stylesheet" href="{% static 'devices.css' %}">
{% endblock %}

{% block content %}
    <div class="jumbotron">
        <div class="container text-center">
            <h1>OMNI AGENT</h1>
            <p>Omni Agent 是一个WATCHDOG程序，帮助用户实现设备值守和设备性能监控。</p>
        </div>
    </div>

    <div class="container">
        <!-- 基础信息部分 -->
        <div class="row">
            <div class="col-md-6">
                <div id="devicemain" style="width:100%;height:300px;"></div>
                <div class="btn-toolbar">
                    <div class="btn-group" role="group" aria-label="true">
                        <a class="btn btn-success" href="{% url 'device_list' %}" role="button">设备清单 &raquo;</a>
                    </div>
                    <div class="btn-group" role="group" aria-label="true">
                        <a class="btn btn-primary" href="" role="button" data-toggle="modal" data-target="#deviceModal">设备详情 &raquo;</a>
                    </div>
                    <div class="btn-group" role="group" aria-label="true">
                        <a class="btn btn-danger" href="" role="button">备份 &raquo;</a>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div id="ipmain" style="width:100%;height:300px;"></div>
                <div class="btn-toolbar">
                    <div class="btn-group" role="group" aria-label="true">
                        <a class="btn btn-primary" href="{% url 'ip_record' %}" role="button">查看业务地址 &raquo;</a>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            分配 IP
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="{% url 'allocate_ip' 'public' %}">分配公网IP</a></li>
                            <li><a href="{% url 'allocate_ip' 'private' %}">分配私网IP</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 监控部分 -->
        <div class="page-header">
            <h2 class="text-center">&laquo; 质量管理 &raquo;</h2>
        </div>
        <div class="row">
            <div class="col-md-4">
                <h3>&raquo; 光模块监控</h3>
                {% if moudle_miss_count == 0 and moudle_new_count == 0 and moudle_ch_count == 0 %}
                    <div class="alert alert-success" role="alert">
                        <span class="glyphicon glyphicon-thumbs-up"></span>
                        24 小时内无光模块变化.
                    </div>
                {% else %}
                    {% if moudle_miss_count != 0 %}
                        <div class="alert alert-danger" role="alert">
                            <strong>危险! </strong>
                            <a href="{% url 'search_moudle' %}?device_name=&status=MISS&time_begin={{ time_begin }}&time_end={{ time_end }}" class="alert-link">
                                24 小时内 {{ moudle_miss_count }} 个模块丢失.
                            </a>
                        </div>
                    {% endif %}
                    {% if moudle_ch_count != 0 %}
                        <div class="alert alert-warning" role="alert">
                            <strong>当心! </strong>
                            <a href="{% url 'search_moudle' %}?device_name=&status=CH&time_begin={{ time_begin }}&time_end={{ time_end }}" class="alert-link">
                                24 小时内 {{ moudle_ch_count }} 个模块变更.
                            </a>
                        </div>
                    {% endif %}
                    {% if moudle_new_count != 0 %}
                        <div class="alert alert-info" role="alert">
                            <strong>注意! </strong>
                            <a href="{% url 'search_moudle' %}?device_name=&status=NEW&time_begin={{ time_begin }}&time_end={{ time_end }}" class="alert-link">
                                24 小时内 {{ moudle_new_count }} 个新模块加入.
                            </a>
                        </div>
                    {% endif %}
                {% endif %}
                {# button显示部分 #}
                {% if moudle_miss_count != 0 %}
                    <p><a class="btn btn-danger" href="{% url 'moudle_list' %}?time_begin={{ time_begin }}&time_end={{ time_end }}" role="button">详情 &raquo;</a></p>
                {% else %}
                    <p><a class="btn btn-primary" href="{% url 'moudle_list' %}?time_begin={{ time_begin }}&time_end={{ time_end }}" role="button">详情 &raquo;</a></p>
                {% endif %}
            </div>
            <div class="col-md-4">
                <h3>&raquo; 端口质量监控</h3>
                {% if crc_port_count != 0 or ipv4head_port_count != 0 %}
                <div class="alert alert-danger" role="alert">
                    巡检 {{ device_ipman_count }} 台设备，发现以下质量问题：
                </div>
                {% else %}
                <div class="alert alert-success" role="alert">
                    巡检 {{ device_ipman_count }} 台设备，未发现问题
                </div>
                {% endif %}
                <ul class="list-group">
                    <li class="list-group-item">
                        <span class="badge">{{ crc_port_count }}</span>
                        CRC端口数
                    </li>
                    <li class="list-group-item">
                        <span class="badge">{{ crc_max_speed.stateCRC__max|floatformat }} 个/h</span>
                        CRC最快增速
                    </li>
                </ul>
                <ul class="list-group">
                    <li class="list-group-item">
                        <span class="badge">{{ ipv4head_port_count }}</span>
                        IPv4头错误端口数
                    </li>
                    <li class="list-group-item">
                        <span class="badge">{{ ipv4head_max_speed.stateIpv4HeadError__max|floatformat }} 个/h</span>
                        IPv4头错误增速
                    </li>
                </ul>
                <p><a class="btn btn-danger" href="{% url 'port_error_list' %}" role="button">详情 &raquo;</a></p>
            </div>
            <div class="col-md-4">
                <h3>&raquo; 单通隐患检查</h3>
                {% if oneway_count != 0 %}
                <div class="alert alert-danger" role="alert">
                    发现 {{ oneway_devices.count }} 台设备 {{ oneway_count }} 个端口怀疑存在单通隐患
                </div>
                {% else %}
                <div class="alert alert-success" role="alert">
                    巡检 {{ device_ipman_count }} 台设备，未发现问题
                </div>
                {% endif %}
                <p><a class="btn btn-primary" href="{% url 'oneway_list' %}?time_begin={{ time_begin }}&time_end={{ time_end }}" role="button">详情 &raquo;</a></p>
            </div>
        </div>

        <!-- 性能管理 -->
        <div class="page-header">
            <h2 class="text-center">&laquo; 性能管理 &raquo;</h2>
        </div>
        <div class="row">
            <div class="col-md-8">
                <h3>&raquo; NAT地址池</h3>
                <div class="alert alert-danger" role="alert">
                    <span class="glyphicon glyphicon-exclamation-sign"></span>
                    NAT 地址池高负荷 TOP 5 网元
                </div>
                <ul class="list-group">
                    {% for pd in heavy_load_pair_devices %}
                        <li class="list-group-item">
                            <span class="badge">{{ pd.nat_total|floatformat }}%</span>
                            {{ pd.device1 }}<strong>:{{ pd.device1_nat_usage }}%</strong> & {{ pd.device2 }}<strong>:{{ pd.device2_nat_usage }}%</strong>
                        </li>
                    {% endfor %}
                </ul>
                <p><a class="btn btn-primary" href="{% url 'natpool_list' %}?time_begin={{ time_begin }}&time_end={{ time_end }}" role="button">详情 &raquo;</a></p>
            </div>
            <div class="col-md-4">
                <h3>&raquo; 光模块监控</h3>
                {% if moudle_miss_count == 0 and moudle_new_count == 0 and moudle_ch_count == 0 %}
                    <div class="alert alert-success" role="alert">
                        <span class="glyphicon glyphicon-thumbs-up"></span>
                        24 小时内无光模块变化.
                    </div>
                {% else %}
                    {% if moudle_miss_count != 0 %}
                        <div class="alert alert-danger" role="alert">
                            <strong>危险! </strong>
                            <a href="{% url 'search_moudle' %}?device_name=&status=MISS&time_begin={{ time_begin }}&time_end={{ time_end }}" class="alert-link">
                                24 小时内 {{ moudle_miss_count }} 个模块丢失.
                            </a>
                        </div>
                    {% endif %}
                    {% if moudle_ch_count != 0 %}
                        <div class="alert alert-warning" role="alert">
                            <strong>当心! </strong>
                            <a href="{% url 'search_moudle' %}?device_name=&status=CH&time_begin={{ time_begin }}&time_end={{ time_end }}" class="alert-link">
                                24 小时内 {{ moudle_ch_count }} 个模块变更.
                            </a>
                        </div>
                    {% endif %}
                    {% if moudle_new_count != 0 %}
                        <div class="alert alert-info" role="alert">
                            <strong>注意! </strong>
                            <a href="{% url 'search_moudle' %}?device_name=&status=NEW&time_begin={{ time_begin }}&time_end={{ time_end }}" class="alert-link">
                                24 小时内 {{ moudle_new_count }} 个新模块加入.
                            </a>
                        </div>
                    {% endif %}
                {% endif %}
                {# button显示部分 #}
                {% if moudle_miss_count != 0 %}
                    <p><a class="btn btn-danger" href="{% url 'moudle_list' %}?time_begin={{ time_begin }}&time_end={{ time_end }}" role="button">详情 &raquo;</a></p>
                {% else %}
                    <p><a class="btn btn-primary" href="{% url 'moudle_list' %}?time_begin={{ time_begin }}&time_end={{ time_end }}" role="button">详情 &raquo;</a></p>
                {% endif %}
            </div>
        </div>

    </div>
    
    <!-- Device Detail Modal -->
    <div class="modal fade bs-example-modal-sm" id="deviceModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">请指定设备</h4>
                </div>
                <div class="modal-body">
                    <form action="{% url 'search_device' %}" method="GET">
                        <div class="form-group">
                            <label for="IPInput">设备IP</label>
                            <input type="text" name="ip_address" class="form-control" id="IPInput" placeholder="1.1.1.1">
                        </div>
                        <p class="text-center"><strong> OR </strong></p>
                        <div class="form-group">
                            <label for="deviceInput">设备名</label>
                            <input type="text" name="device_name" class="form-control" id="deviceInput" placeholder="DS...">
                        </div>
                        <button type="submit" class="btn btn-primary">搜索</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block tail_script %}
<script src="{% static 'echarts.min.js' %}"></script>
<!-- 引入 vintage 主题 -->
<script src="{% static 'infographic.js' %}"></script>
<script>
    $('#deviceModal').on('shown.bs.modal', function () {
        $('#myInput').focus()
    });

    $(document).ready(function(){
        var devicePie = echarts.init(document.getElementById('ipmain'), 'infographic');
        devicePie.showLoading();

        var option = {
            title : {
                show: false,
            },
            legend: {
                orient : 'vertical',
                x : 'right',
                data:['公网','私网']
            },
            tooltip : {
                trigger: 'item',
                formatter: "{a} <br/>{b} : {c} ({d}%)"
            },
            calculable : true,
            series : [
                {
                    name:'业务地址',
                    type:'pie',
                    data:[
                        {value:'{{ ip_public_count }}', name:'公网'},
                        {value:'{{ ip_private_count }}', name:'私网'},
                    ].sort(function (a, b) { return a.value - b.value; }),
                }
            ]
        };
        devicePie.hideLoading();
        devicePie.setOption(option);
        window.addEventListener("resize", function () {
            devicePie.resize();
        });
    });

    $(document).ready(function(){
        var ipPie = echarts.init(document.getElementById('devicemain'), 'infographic');
        ipPie.showLoading();

        var option = {
            title : {
                show: false,
            },
            legend: {
                orient : 'vertical',
                x : 'right',
                data:['城域网设备','承载网设备','其他设备']
            },
            tooltip : {
                trigger: 'item',
                formatter: "{a} <br/>{b} : {c} ({d}%)"
            },
            calculable : true,
            series : [
                {
                    name:'监控设备',
                    type:'pie',
                    data:[
                        {value:'{{ device_ipman_count }}', name:'城域网设备'},
                        {value:'{{ device_cmnet_count }}', name:'承载网设备'},
                        {value:'{{ device_oth_count }}', name:'其他设备'},
                    ].sort(function (a, b) { return a.value - b.value; }),
                }
            ]
        };
        ipPie.hideLoading();
        ipPie.setOption(option);
        window.addEventListener("resize", function () {
            ipPie.resize();
        });
    });
</script>
{% endblock %}